<h1> Metamorphylo </h1>

<h2> DATA </h2>
<h3>[This github repository](https://github.com/bnetobradley/metamorphylo) contains the raw data and code for analyses used in B.M. Neto-Bradley's MSc. Thesis.</h3>

<h4> In the /data folder of this repository, there are 3 sets of raw data files, corresponding to measurements taken for 138 individuals growing at the UBC and Van Dusen Botanical Gardens. All of these data have been measured on the same set of leaves, between May and September of 2019.</h4>
<h3>1. Rapid A/Ci Response (RACiR) data</h3>

<h5> Files: 
Find these under /data/licor_data/txt/ files are named in the following format  yyyy-mm-dd-hhmm_genus_species </h5>

<h5> Blurb:  RACiR curves (as described in Stinziano et al. 2017) characterize the change in Net photosynthesis A relative to changes in CO2. Functionally this describes the physiological constraints of how quickly and efficiently a plant can take up CO2. During our RACiR curve measurements, CO2 is ramped from 10 ppm to 1010 ppm at a rate of + 100 ppm per minute. While this is ongoing, CO2 accumulates in the chamber such that the true CO2 contents of the chamber are slightly out of sync with the concentration of CO2 measured by the machine. In order to correct for this lag, two curves are measured - a data curve and an empty curve for callibrating the data curve. </h5>

<h5> Data Specifics:
The RACiR data is comprised of 2 data files: an "empty curve" and a "data curve" (see above.) The empty curve characterizes how CO2 accumulates in an empty chamber throughout the course of the A/Ci measurement, and the data curve characterizes a leaf's photosynthetic rates change in response to increasing CO2. Empty curves were collected every hour to two hours - for every empty curve multiple that were collected in close temporal proximity can be corrected (for the lag in CO2 measured - as described above.) Every measurement has its own txt file that was generated by the LiCor6800 machine when the measurement was finalized. </h5>

<h5> Time & Place:
RACiR curves were measured on the youngest fully expanded leaves of each of the 138 species studied here. These measurements were taken between May 5th and July 18th 2019 at the UBC and VanDusen Botanical Garden. </h5>

<h3>2. Morphological measurements </h3>

<h5> Files: 
Find these under /data/netobradley_garden_data.csv </h5>

<h5> Blurb: 
After each RACiR curve was measured, the leaf (or several leaves in the case of small leaves/needles) on which this was taken were harvested measured for leaf thickness (at three points across the leaf - while avoiding the midrib) and put in a sealed bag, which was stored in a cooler overnight. The next morning, the leaves were measured for fresh mass and leaf area. The leaves were then dried for 48 hours in an oven at 60 degrees Celsius. After this the leaves were weighed for dry mass.</h5>

<h5> Time & Place: 
These measurements were taken the day of, or the following day at the Beaty Biodiversity Research Centre at the UBC Vancouver Campus. </h5>

<h3>3. Chemical analyses for Nitrogen and Carbon of leaves </h3>

<h5> Files: 
Find these under /data/netobradley_msc_leaf_chemistry.csv </h5>

<h5> Blurb:
Once the leaf tissues were dried, these were sent off for chemical analysis for the Nitrogen and Carbon contents by combustion.
</h5>

<h5> Time & Place: 
These measurements were done at the Analytical Chemical Services Laboratory (at the BC Ministry of Environment and Climate Change Strategy), during September 2019. </h5>

<h2> CODE </h2>
<h4> In the /R folder of this repository, there are multiple sections of code required in the mental gymnastics that are cleaning and manipulating these datasets. Below is a roadmap to these gymnastics. </h4>

<h3>1. Cleaning: read the RACiR data </h3>
<h4> As mentioned above (in the description of the RACiR data,) the LICOR Instrument automatically generates (both) a .txt and .xls file for each set of measurements taken. Both the .txt and .xls file are in non-tidy format, and need some specific cleaning up as they are read into R. We have written a function read_li68() that cleans this up by chopping out the non-tidy metadata sections from the dataframe in R (these metadata are safe and untouched in the original data files.) In this section we compile all of the txt files into on dataframe - where individual measurements are identifiable via a unique ID. </h4>

<h3>2. Cleaning: correct the RACiR data by leaf area in chamber</h3>
<h4> Now that the data is compiled into one place, in a readable format - we need to correct measurements that were taken on leaves smaller than the full chamber size, i.e. the LICOR software calculates a series of photosynthetic related variables from a handful of gas exchange measurements, while assuming that the amount of leaf photosynthetic area in the chamber is equal to the full size of the chamber - due to irregular or small leaf shapes this is often not true. In order to correct this, we need to enter the true amount of leaf area in the chamber and then recalculate the derived photosynthetic related variables based on this leaf area.</h4>
<h4> true leaf area in chamber was estimated by placing a circle (either 2cm^2 or 6cm^2) on scanned leaves 3 times, to estimate the approximate area that was inside the chamber. In this section we average these estimates for each leaf measured, and replace the assumed full chamber value (unless the chamber was indeed full.) We then use our function **recalc_licor68()** to recalculate the derived photosynthetic values.
</h4>

<h3>3. Cleaning: correct the RACiR data by CO2 lag empty/data </h3>
<h4> Now that we have read, cleaned and area-corrected our data. There's one last step - we need to correct the accumulation of CO2 in the RACiR data curve by using the empty curve as a calibration. In order to carry this out - we need to 
i) cut off the non-linear ends of the CO2 ramp (the beginings and ends) on the empty curves
ii) fit a linear model to the empty curves and subtract this from the data curves 
iii) clean up the non-linear ends of the data curves </h4>

<h3>4. Cleaning: fit Parameters to the clean and corrected RACiR data </h3>
<h4> Curves are fit using the plantecophys package. </h4>
